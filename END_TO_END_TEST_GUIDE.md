# End-to-End Testing Guide - AstroVoice Mobile App

## **Prerequisites**

### **1. Backend API Must Be Running**
```bash
# Check if running
ps aux | grep mobile_api_service | grep -v grep

# If not running, start it:
cd /Users/nikhil/workplace/voice_v1
source venv/bin/activate
python mobile_api_service.py

# Should show: INFO: Uvicorn running on http://0.0.0.0:8001
```

### **2. Database Must Be Initialized**
```bash
# Verify database exists
psql -h localhost -U nikhil -d astrovoice -c "SELECT COUNT(*) FROM astrologers;"

# Should return: 3 astrologers

# If not initialized:
psql -h localhost -U nikhil -d postgres -c "CREATE DATABASE astrovoice;"
psql -h localhost -U nikhil -d astrovoice -f database_schema.sql
```

### **3. Mobile App Must Be Running**
```bash
cd /Users/nikhil/workplace/voice_v1/astro-voice-mobile
npx expo start --web --clear

# Wait for: "Web Bundled" message
# Open browser to: http://localhost:8081
```

## **Complete User Flow Test**

### **Step 1: App Launch**
**Action**: Open http://localhost:8081 in browser

**Expected**:
- ‚úÖ Splash screen shows "Kundli" logo
- ‚úÖ Displays for 3 seconds
- ‚úÖ Auto-navigates to phone auth

**Verify**: Splash screen displays correctly

---

### **Step 2: Phone Authentication**
**Action**: Click "Skip (Testing Mode)" button

**Expected**:
- ‚úÖ Navigates to onboarding form
- ‚úÖ No errors in console

**Verify**: Onboarding form appears

---

### **Step 3: Onboarding - Step 1 (Name)**
**Action**: 
- Enter name: "Test User"
- Click "Continue ‚Üí"

**Expected**:
- ‚úÖ Name validated (letters and spaces only)
- ‚úÖ Advances to Step 2

**Verify**: Date of birth step appears

---

### **Step 4: Onboarding - Step 2 (Date of Birth)**
**Action**:
- Select date: 15
- Select month: August
- Select year: 1990
- Click "Continue ‚Üí"

**Expected**:
- ‚úÖ Date saved
- ‚úÖ Advances to Step 3

**Verify**: Birth time question appears

---

### **Step 5: Onboarding - Step 3 (Birth Time)**
**Action**:
- Click "Yes, I know"
- Select hour: 02
- Select minute: 30
- Select period: PM
- Click "Continue ‚Üí"

**Expected**:
- ‚úÖ Time saved
- ‚úÖ Advances to Step 4

**Verify**: Gender selection appears

---

### **Step 6: Onboarding - Step 4 (Gender)**
**Action**:
- Select "Male" or "Female"
- Click "Continue ‚Üí"

**Expected**:
- ‚úÖ Gender saved
- ‚úÖ Advances to Step 5

**Verify**: Place of birth step appears

---

### **Step 7: Onboarding - Step 5 (Place of Birth)**
**Action**:
- Enter: "Mumbai, Maharashtra"
- Click "Continue ‚Üí"

**Expected**:
- ‚úÖ Place saved
- ‚úÖ Advances to Step 6

**Verify**: Language selection appears

---

### **Step 8: Onboarding - Step 6 (Languages)**
**Action**:
- Select "English" and "Hindi"
- Click "Complete Profile"

**Expected**:
- ‚úÖ Loading indicator appears
- ‚úÖ Console log: "üìù Submitting user data..."
- ‚úÖ Console log: "‚úÖ User registered: user_xxxxx"
- ‚úÖ Console log: "üí∞ Welcome bonus: 500"
- ‚úÖ Success screen shows "Profile Completed!"

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT user_id, full_name, phone_number FROM users ORDER BY created_at DESC LIMIT 1;"
# Should show new user

psql -h localhost -U nikhil -d astrovoice -c "SELECT wallet_id, user_id, balance FROM wallets ORDER BY created_at DESC LIMIT 1;"
# Should show wallet with ‚Çπ500
```

**API Logs Should Show**:
```
‚úÖ User created/updated: user_xxxxx
‚úÖ Wallet created/updated: wallet_user_xxxxx
INFO: POST /api/users/register HTTP/1.1 200 OK
```

---

### **Step 9: Complete Onboarding**
**Action**: Click "Get Started ‚ú®"

**Expected**:
- ‚úÖ Navigates to Home Screen
- ‚úÖ Loading indicator shows

**Verify**: Home screen appears

---

### **Step 10: Home Screen - Load Astrologers**
**Expected**:
- ‚úÖ Console log: "‚úÖ Loaded 3 astrologers from API"
- ‚úÖ 3 astrologer cards display:
  - AstroGuru (Vedic, 25 years)
  - Mystic Guide (Western, 10 years)
  - Cosmic Sage (Vedic, 30 years)
- ‚úÖ Wallet shows "‚Çπ500"
- ‚úÖ Categories show: All, Vedic, Western, etc.

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT display_name, specialization, rating FROM astrologers;"
```

**API Logs Should Show**:
```
INFO: GET /api/astrologers HTTP/1.1 200 OK
INFO: GET /api/wallet/user_xxxxx HTTP/1.1 200 OK
```

**Test Pull-to-Refresh**:
- Pull down on screen
- Should reload astrologers

---

### **Step 11: Start Chat Session**
**Action**: Click "üí¨ Chat ‚Ä¢ ‚Çπ8/min" on AstroGuru card

**Expected**:
- ‚úÖ Loading screen: "Starting chat session..."
- ‚úÖ Console log: "üöÄ Starting chat with AstroGuru"
- ‚úÖ Console log: "‚úÖ Chat session started: conv_xxxxx"
- ‚úÖ Chat screen appears
- ‚úÖ Greeting message in Hindi displays
- ‚úÖ Header shows AstroGuru profile
- ‚úÖ Timer starts at 00:00
- ‚úÖ Wallet shows ‚Çπ500

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT conversation_id, user_id, astrologer_id, status FROM conversations ORDER BY started_at DESC LIMIT 1;"
# Should show new conversation with status='active'

psql -h localhost -U nikhil -d astrovoice -c "SELECT sender_type, content FROM messages ORDER BY sent_at DESC LIMIT 1;"
# Should show greeting message from astrologer
```

**API Logs Should Show**:
```
‚úÖ Conversation created: conv_user_xxxxx_yyy
INFO: POST /api/chat/start HTTP/1.1 200 OK
```

---

### **Step 12: Send Chat Message**
**Action**:
- Type: "Can you help me with my career?"
- Click send button (üì§)

**Expected**:
- ‚úÖ Message appears in chat (user message, right-aligned, blue)
- ‚úÖ Console log: "‚úÖ Message sent to API"
- ‚úÖ After 1.5 seconds, astrologer response appears
- ‚úÖ Conversation total messages updates

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT sender_type, content FROM messages ORDER BY sent_at DESC LIMIT 5;"
# Should show both user and astrologer messages
```

**API Logs Should Show**:
```
INFO: POST /api/chat/message HTTP/1.1 200 OK
(appears twice - once for user, once for astrologer)
```

---

### **Step 13: Test Message Suggestions**
**Action**: Click any suggestion button (e.g., "What does my birth chart say?")

**Expected**:
- ‚úÖ Message sent immediately
- ‚úÖ Suggestion appears in chat
- ‚úÖ Astrologer responds

---

### **Step 14: Wait for Timer**
**Action**: Watch the timer for 30 seconds

**Expected**:
- ‚úÖ Timer increments: 00:01, 00:02, ...
- ‚úÖ At 00:30 (TEST_MODE), balance deducts: ‚Çπ500 ‚Üí ‚Çπ492
- ‚úÖ Wallet balance updates in header

---

### **Step 15: End Chat Session**
**Action**: Click red "End" button (üìû End)

**Expected**:
- ‚úÖ Console log: "End button pressed!"
- ‚úÖ Console log: "‚úÖ Conversation ended in database"
- ‚úÖ Navigates to review screen
- ‚úÖ Shows astrologer profile
- ‚úÖ Shows session duration (e.g., "00:45")

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT conversation_id, status, total_duration_seconds FROM conversations ORDER BY ended_at DESC LIMIT 1;"
# Should show status='completed' and duration in seconds
```

**API Logs Should Show**:
```
‚úÖ Conversation ended: conv_user_xxxxx_yyy
INFO: POST /api/chat/end HTTP/1.1 200 OK
```

---

### **Step 16: Submit Review**
**Action**:
- Click 5th star (5-star rating)
- Optionally type review: "Excellent guidance!"
- Click "Submit Review"

**Expected**:
- ‚úÖ Loading indicator appears on button
- ‚úÖ Console log: "üìù Submitting review..."
- ‚úÖ Console log: "‚úÖ Review submitted: review_xxxxx"
- ‚úÖ Thank you modal appears
- ‚úÖ "üéâ Thank You!" message shows

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT review_id, rating, review_text FROM session_reviews ORDER BY created_at DESC LIMIT 1;"
# Should show 5-star review

psql -h localhost -U nikhil -d astrovoice -c "SELECT display_name, rating, total_reviews FROM astrologers WHERE astrologer_id = 'ast_guru_001';"
# Should show rating updated (average of all reviews)
```

**API Logs Should Show**:
```
‚úÖ Review created: review_user_xxxxx_yyy
INFO: POST /api/reviews/submit HTTP/1.1 200 OK
```

---

### **Step 17: Return to Home**
**Action**: Click "Continue" on thank you modal

**Expected**:
- ‚úÖ Navigates back to Home Screen
- ‚úÖ AstroGuru now shows updated rating
- ‚úÖ Review count incremented

---

### **Step 18: Open Wallet Screen**
**Action**: Click wallet button in header (üí≥ ‚Çπ500) OR navigate to Wallet tab

**Expected**:
- ‚úÖ Loading screen appears
- ‚úÖ Console log: "‚úÖ Wallet loaded: ‚Çπxxx"
- ‚úÖ Current balance displays (should be less than ‚Çπ500 if chat deducted)
- ‚úÖ Recent transactions section shows
- ‚úÖ Empty state if no transactions

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT balance FROM wallets WHERE user_id = (SELECT user_id FROM users ORDER BY created_at DESC LIMIT 1);"
```

**API Logs Should Show**:
```
INFO: GET /api/wallet/user_xxxxx HTTP/1.1 200 OK
```

---

### **Step 19: Recharge Wallet**
**Action**:
- Click "‚Çπ1,000" recharge button
- (Modal would appear in production)

**Expected**:
- ‚úÖ Loading/processing indicator
- ‚úÖ Console log: "‚úÖ Recharged ‚Çπ1000, new balance: ‚Çπxxxx"
- ‚úÖ Balance updates immediately
- ‚úÖ Transaction appears in list
- ‚úÖ Navigates to success screen

**Verify in Database**:
```bash
psql -h localhost -U nikhil -d astrovoice -c "SELECT transaction_type, amount, balance_before, balance_after FROM transactions ORDER BY created_at DESC LIMIT 1;"
# Should show recharge with updated balances

psql -h localhost -U nikhil -d astrovoice -c "SELECT balance FROM wallets WHERE user_id = (SELECT user_id FROM users ORDER BY created_at DESC LIMIT 1);"
# Should show increased balance
```

**API Logs Should Show**:
```
‚úÖ Transaction created: txn_user_xxxxx_yyy
INFO: POST /api/wallet/recharge HTTP/1.1 200 OK
```

---

### **Step 20: Pull to Refresh Wallet**
**Action**: Pull down on wallet screen

**Expected**:
- ‚úÖ Refresh indicator shows
- ‚úÖ Balance reloads from API
- ‚úÖ Transactions reload
- ‚úÖ Data updates

---

## **Complete Test Checklist**

### **Backend API** ‚úÖ
- [x] Health check: `curl http://localhost:8001/health`
- [x] All 12 endpoints tested: `./test_mobile_api.sh`
- [x] Database tables created
- [x] Sample data loaded (3 astrologers)

### **Mobile App Screens** ‚è≥
- [ ] Splash screen displays
- [ ] Phone auth skip works
- [ ] Onboarding form submits ‚Üí User created in DB
- [ ] Home screen loads astrologers from API
- [ ] Chat button opens chat session
- [ ] Chat messages send and store in DB
- [ ] End button works ‚Üí Conversation marked completed
- [ ] Review screen accepts rating ‚Üí Rating updates astrologer
- [ ] Wallet shows balance from API
- [ ] Recharge works ‚Üí Transaction created in DB

### **Data Persistence** ‚è≥
- [ ] User data in PostgreSQL users table
- [ ] Wallet with ‚Çπ500 in wallets table
- [ ] Conversation in conversations table
- [ ] Messages in messages table
- [ ] Review in session_reviews table
- [ ] Astrologer rating updated
- [ ] Transactions in transactions table
- [ ] user_id in AsyncStorage
- [ ] Wallet balance cached in AsyncStorage

### **Error Handling** ‚è≥
- [ ] API errors show user-friendly messages
- [ ] Retry buttons work
- [ ] Loading states prevent duplicate submissions
- [ ] Offline mode shows cached data

## **Test Results Template**

### **Test Execution Log**

```
Date: _____________
Tester: _____________
Backend API: Running ‚úÖ / Not Running ‚ùå
Database: Initialized ‚úÖ / Not Initialized ‚ùå
Mobile App: Running ‚úÖ / Not Running ‚ùå

Step 1 - Splash Screen: PASS ‚úÖ / FAIL ‚ùå
  Notes: ___________

Step 2 - Phone Auth Skip: PASS ‚úÖ / FAIL ‚ùå
  Notes: ___________

Step 3 - Onboarding Name: PASS ‚úÖ / FAIL ‚ùå
  User ID Created: ___________

Step 4 - Onboarding DOB: PASS ‚úÖ / FAIL ‚ùå

Step 5 - Onboarding Time: PASS ‚úÖ / FAIL ‚ùå

Step 6 - Onboarding Gender: PASS ‚úÖ / FAIL ‚ùå

Step 7 - Onboarding Place: PASS ‚úÖ / FAIL ‚ùå

Step 8 - Onboarding Languages: PASS ‚úÖ / FAIL ‚ùå
  Wallet Created: ‚Çπ___________

Step 9 - Home Screen Load: PASS ‚úÖ / FAIL ‚ùå
  Astrologers Count: ___________

Step 10 - Start Chat: PASS ‚úÖ / FAIL ‚ùå
  Conversation ID: ___________

Step 11 - Send Message: PASS ‚úÖ / FAIL ‚ùå
  Messages in DB: ___________

Step 12 - End Chat: PASS ‚úÖ / FAIL ‚ùå
  Status Updated: ___________

Step 13 - Submit Review: PASS ‚úÖ / FAIL ‚ùå
  Review ID: ___________
  Astrologer Rating: ___________

Step 14 - Wallet Screen: PASS ‚úÖ / FAIL ‚ùå
  Balance Shown: ‚Çπ___________

Step 15 - Recharge Wallet: PASS ‚úÖ / FAIL ‚ùå
  New Balance: ‚Çπ___________
  Transaction ID: ___________

OVERALL RESULT: PASS ‚úÖ / FAIL ‚ùå
```

## **Console Logs to Watch For**

### **Successful Flow Logs**

```javascript
// Onboarding
üìù Submitting user data: {...}
‚úÖ User registered: user_xxxxx
üí∞ Welcome bonus: 500

// Home Screen
‚úÖ Loaded 3 astrologers from API

// Chat Session
üöÄ Starting chat with AstroGuru
‚úÖ Chat session started: conv_xxxxx
‚úÖ Message sent to API

// Review
üìù Submitting review...
‚úÖ Review submitted: review_xxxxx

// Wallet
‚úÖ Wallet loaded: ‚Çπ500
‚úÖ Recharged ‚Çπ1000, new balance: ‚Çπ1500
```

### **Error Logs to Investigate**

```javascript
‚ùå Registration error: ...
‚ùå Failed to load astrologers: ...
‚ùå Failed to start session: ...
‚ùå Failed to send message: ...
‚ùå Failed to submit review: ...
‚ùå Failed to load wallet: ...
‚ùå Recharge failed: ...
```

## **Database Verification Queries**

### **After Complete Flow**

```bash
# Count total records
psql -h localhost -U nikhil -d astrovoice << EOF
SELECT 
  (SELECT COUNT(*) FROM users) as users,
  (SELECT COUNT(*) FROM wallets) as wallets,
  (SELECT COUNT(*) FROM conversations) as conversations,
  (SELECT COUNT(*) FROM messages) as messages,
  (SELECT COUNT(*) FROM session_reviews) as reviews,
  (SELECT COUNT(*) FROM transactions) as transactions;
EOF

# View latest user journey
psql -h localhost -U nikhil -d astrovoice << EOF
-- Latest user
SELECT user_id, full_name, phone_number FROM users ORDER BY created_at DESC LIMIT 1;

-- Their wallet
SELECT balance FROM wallets ORDER BY created_at DESC LIMIT 1;

-- Their conversations
SELECT conversation_id, status, total_messages, total_duration_seconds 
FROM conversations ORDER BY started_at DESC LIMIT 1;

-- Their messages
SELECT sender_type, content FROM messages ORDER BY sent_at DESC LIMIT 5;

-- Their reviews
SELECT rating, review_text FROM session_reviews ORDER BY created_at DESC LIMIT 1;

-- Their transactions
SELECT transaction_type, amount, balance_after FROM transactions ORDER BY created_at DESC LIMIT 1;
EOF
```

## **Expected Final State**

### **Database Tables**
- **users**: 1+ records
- **wallets**: 1+ records with ‚Çπ500 or more
- **conversations**: 1+ records (status='completed')
- **messages**: 2+ records (greeting + user message + responses)
- **session_reviews**: 1+ records
- **transactions**: 0-1+ records (if recharged)
- **astrologers**: 3 records (1 with updated rating)

### **Mobile App State**
- **AsyncStorage**:
  - user_id: stored
  - user_data: stored
  - is_onboarded: true
  - wallet_balance: cached
- **UI State**:
  - Logged in
  - Onboarded
  - Can navigate all screens
  - Data loading from API

## **Performance Benchmarks**

- ‚úÖ Onboarding submission: < 1 second
- ‚úÖ Home screen load: < 2 seconds
- ‚úÖ Chat session start: < 1 second
- ‚úÖ Message send: < 500ms
- ‚úÖ Review submit: < 1 second
- ‚úÖ Wallet load: < 1 second
- ‚úÖ Recharge: < 1 second

## **Common Issues & Solutions**

### Issue: "User not found" after onboarding
**Solution**: Check AsyncStorage, verify user_id was saved
```javascript
// In browser console
import('@react-native-async-storage/async-storage').then(async (AsyncStorage) => {
  const userId = await AsyncStorage.default.getItem('@astrovoice:user_id');
  console.log('Stored user_id:', userId);
});
```

### Issue: Astrologers not loading
**Solution**: 
1. Check backend API is running: `curl http://localhost:8001/api/astrologers`
2. Check database has astrologers: `psql -h localhost -U nikhil -d astrovoice -c "SELECT COUNT(*) FROM astrologers;"`

### Issue: Chat session won't start
**Solution**: Check wallet balance > 0 in database

### Issue: Review submission fails
**Solution**: Verify conversation_id is being passed correctly

### Issue: Wallet shows ‚Çπ0
**Solution**: Check if wallet was created during onboarding

---

## **Success Criteria**

**All systems working if**:
- ‚úÖ User can complete full onboarding
- ‚úÖ User data appears in PostgreSQL
- ‚úÖ Astrologers load from database
- ‚úÖ Chat session creates conversation in DB
- ‚úÖ Messages store in database
- ‚úÖ Review updates astrologer rating
- ‚úÖ Wallet operations work
- ‚úÖ No critical errors in console
- ‚úÖ All database tables populated correctly

**Integration is SUCCESSFUL** when all 20 steps above pass! üéâ

---

**Test Status**: ‚è≥ Ready to Execute
**Next**: Run through all 20 steps and verify each one

